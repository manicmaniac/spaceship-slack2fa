#!/bin/sh

set -eu

if [ $# -ne 1 ]; then
    echo "usage: $0 <VERSION>" >&2
    exit 1
fi

version="$1" find .github/workflows -type f -name '*.yml' -exec yq -i '
with(.jobs[]
     | select(.steps).steps[]
     | select(.uses and .with.ruby-version).with.ruby-version
     | select(. != "${*")
     | select(. < strenv(version));
  . = strenv(version)
) |
with(.jobs[]
     | select(.strategy.matrix.ruby-version).strategy.matrix.ruby-version;
  . += [strenv(version) | . style="single"]
  | . = sort
  | . = reverse
  | . = unique_by(match("^\d+\.\d+").string)
  | . = reverse
)
' {} \;
